<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Tech Talk by Andy O'Neill</title>

        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/globant.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/monokai.css">
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-background="rgb(0, 122, 209)">
                    <h2>Building an Emulator with WebAssembly and Rust</h2>
                    <gamebuino-emulator src="https://raw.githubusercontent.com/Rodot/Games-META/master/binaries/METAtris/METAtris.bin">
                    </gamebuino-emulator>
                    <a href="http://games.aoneill.com/wasm-proto">http://games.aoneill.com/wasm-proto</a>
                </section>

                <section data-background="rgb(4, 217, 206)">
                    <img src="images/makerbuino.png" alt="MAKERbuino" />
                    <img src="images/gamebuino.png" alt="Gamebuino" />
                </section>

                <section data-background="rgb(4, 217, 206)">
                    <h2>Microcontroller</h2>
                    <ul>
                        <li>32-bit ARM Cortex-M0+ @ 48MHz</li>
                        <li>256KB flash</li>
                        <li>32KB SRAM</li>
                        <li>Up to 52 programmable I/O pins</li>
                        <li>6 serial communication modules (SERCOM)</li>
                        <li>Timers and interrupts</li>
                        <li>Direct memory access (DMA) controller</li>
                    </ul>
                </section>

                <section data-background="rgb(4, 217, 206)">
                    <h2>Screen</h2>
                    <ul>
                        <li>160 × 128 pixels</li>
                        <li>65K colors</li>
                        <li>Communicates over SERCOM4 using SPI</li>
                    </ul>
                </section>

                <section data-background="rgb(4, 217, 206)">
                    <h2>Buttons</h2>
                    <ul>
                        <li>Communicates over SERCOM4 using SPI</li>
                        <li>D-pad, A, B, Menu, and Home all encoded as a single byte</li>
                    </ul>
                </section>

                <section data-background="rgb(4, 217, 206)">
                    <h2>Ignored</h2>
                    <ul>
                        <li>Sound</li>
                        <li>SD card</li>
                        <li>Lights</li>
                        <li>USB</li>
                    </ul>
                </section>

                <section data-background="rgb(4, 217, 206)">
                    <pre><code data-trim data-line-numbers class="plaintext">
                        listen for button input
                        initialize emulator with game ROM
                        call gameLoop()

                        function gameLoop() {
                            tell emulator which buttons are pressed
                            loop for some number of steps {
                                simulate next CPU instruction
                            }
                            draw screen to &lt;canvas&gt;
                            schedule gameLoop() to be called in the future
                        }
                    </code></pre>
                </section>
 
                <section data-background="rgb(4, 217, 206)">
                    <h2>Why?</h2>
                    <img src="images/comparison.png" height="500" />
                </section>

                <section data-background="rgb(153, 90, 230)">
                    <pre><code data-trim data-line-numbers>
                        (module
                          (func (export "add") (param $lhs i32) (param $rhs i32)
                            (result i32)
                            (i32.add
                              (local.get $lhs)
                              (local.get $rhs)
                            )
                          )
                        )
                    </code></pre>
                </section>

                <section data-background="rgb(153, 90, 230)">
                    <pre><code data-trim data-line-numbers="|7-9|10">
                        &#x3C;!DOCTYPE html&#x3E;
                        &#x3C;html&#x3E;
                        &#x3C;head&#x3E; &hellip; &#x3C;/head&#x3E;
                        &#x3C;body&#x3E;
                          &#x3C;script&#x3E;
                            (async function() {
                              let obj = await WebAssembly.instantiateStreaming(
                                fetch("add.wasm")
                              );
                              console.log(obj.instance.exports.add(1, 2)); // 3
                            })();
                          &#x3C;/script&#x3E;
                        &#x3C;/body&#x3E;
                        &#x3C;/html&#x3E;
                    </code></pre>
                </section>
                
                <section data-background="rgb(153, 90, 230)">
                    <pre style="font-size: 0.4em;"><code data-trim data-line-numbers="|17-20" style="max-height: 600px;">
                    (module
                        (import "js" "mem" (memory 1))
                        (data (i32.const 0) "HAL")
                        (func (export "doSomething")
                            (local $i i32)
                            (loop $loop
                                (i32.store8 
                                    (local.get $i)
                                    (i32.add
                                        (i32.load8_u
                                            (local.get $i)
                                        )
                                        (i32.const 1)
                                    )
                                )
                                (local.set $i
                                    (i32.add
                                        (i32.const 1)
                                        (local.get $i)
                                    )
                                )
                                (br_if $loop
                                    (i32.lt_u
                                        (local.get $i)
                                        (i32.const 3)
                                    )
                                )
                            )
                        )
                    )
                    </code></pre>
                </section>

                <section data-background="rgb(153, 90, 230)">
                    <wasm-slide></wasm-slide>
                </section>

                <section data-background="rgb(250, 12, 147)">
                    <img src="https://www.rust-lang.org/static/images/wasm-ferris.png" style="border: none; padding: 5px; width: 200px; background-color: white;">
                    <h2>Rust + WebAssembly</h2>
                    <ul>
                        <li><code>wasm-pack</code></li>
                        <li>Small runtime, no garbage collector</li>
                        <li>Low-level control</li>
                        <li>Focus on safety</li>
                        <li>Modern features</li>
                        <li>Excellent error messages and documentation</li>
                    </ul>
                </section>

                <section data-background="rgb(250, 12, 147)">
                    <pre><code data-trim data-line-numbers style="max-height: 600px;" class="rust">
                        pub struct St7735 {
                            …
                            image_data: [0; St7735::WIDTH * St7735::HEIGHT];
                        }
                        
                        impl St7735 {
                            …
                            pub fn byte_received(&mut self, value: u8, 
                                porta: &PortRegisters, portb: &PortRegisters) {
                                …
                                let r = (0b1111100000000000 & pixel_data) &gt;&gt; 8;
                                let g = (0b0000011111100000 & pixel_data) &gt;&gt; 3;
                                let b = (0b0000000000011111 & pixel_data) &lt;&lt; 3;
                                let color = (255 &lt;&lt; 24) | // alpha
                                            (b   &lt;&lt; 16) | // blue
                                            (g   &lt;&lt;  8) | // green
                                             r;           // red
                                …
                                self.image_data[base_index] = color;
                            }
                        }
                    </code></pre>
                </section>

                <section data-background="rgb(250, 12, 147)">
                    <pre><code data-trim data-line-numbers style="max-height: 600px;" class="javascript">
                        step(timestamp) {
                            … // Snip code to calculate number of iterations
                    
                            // Run number of emulated cycles equal to `iterations`
                            this.gamebuino.run(iterations, this.buttonState);
                    
                            // Draw to canvas
                            let buf8 = new Uint8ClampedArray(
                                memory.buffer,                  // buffer
                                this.gamebuino.image_pointer(), // byteOffset
                                160 * 128 * 4                   // length
                            );
                            this.imageData.data.set(buf8);
                            this.ctx.putImageData(this.imageData, 0, 0);
                            this.ctx.drawImage(this.canvas, 0, 0);
                    
                            // Request next step
                            this.requestId = 
                                requestAnimationFrame(t => this.step(t));
                        }
                    </code></pre>
                </section>

                <section data-background="rgb(250, 12, 147)">
                    <pre><code data-trim data-line-numbers style="max-height: 600px;" class="rust">
            fn execute_instruction(&mut self,
                                   instruction: Instruction) {
                match instruction {
                    Instruction::LslImm { rs, rd, offset } => {
                        let original = self.read_register(rs);
                        let result = original << offset;
                        self.set_register(rd, result);
                        self.cond_reg.c = 
                            original & (1 << offset) != 0;
                        self.set_nz(result);
                    }
                    …
                    Instruction::Beq { offset } => {
                        if self.cond_reg.z {
                            self.set_register(PC_INDEX, 
                              self.read_register(PC_INDEX) + offset);
                            self.increment_pc();
                        }
                    }
                    …
                }
            }
                    </code></pre>
                </section>

                <section data-background="rgb(78, 91, 101)">
                    <h2>Links</h2>
                    <ul>
                        <li><a href="https://github.com/aoneill01/wasm-gamebuino">github.com/aoneill01/wasm-gamebuino</a></li>
                        <li><a href="https://gamebuino.com/">gamebuino.com</a></li>
                        <li><a href="https://rustwasm.github.io/docs/book/">rustwasm.github.io/docs/book/</a></li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="js/reveal.js"></script>

        <script>
            // More info about config & dependencies:
            // - https://github.com/hakimel/reveal.js#configuration
            // - https://github.com/hakimel/reveal.js#dependencies
            Reveal.initialize({
                hash: true,
                dependencies: [
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/highlight/highlight.js' },
                    { src: 'plugin/notes/notes.js', async: true }
                ]
            });
        </script>
        <script src="https://unpkg.com/@aoneill01/wasm-gamebuino" type="module"></script>
        <script src="js/wasm-slide.js"></script>
    </body>
</html>
